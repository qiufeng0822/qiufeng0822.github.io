<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éº»å°†ç§¯åˆ†è®¡ç®—å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
        }

        body {
            background-color: #f5f0e8;
            color: #333;
            padding-bottom: 20px;
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            padding: 15px;
        }

        /* æ ‡é¢˜æ ·å¼ */
        .page-title {
            text-align: center;
            font-size: 22px;
            font-weight: bold;
            color: #8B4513;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* æ¨¡å—æ ·å¼ */
        .module {
            background-color: #fff;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .module-title {
            font-size: 18px;
            font-weight: 600;
            color: #8B4513;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }

        /* å¤§å°é€‰æ‹©æ ·å¼ */
        .size-options {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .size-option {
            flex: 1;
            height: 44px;
            line-height: 44px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .size-option.active {
            background-color: #8B4513;
            color: #fff;
            border-color: #8B4513;
        }

        /* ç‰Œå‹åˆ†æ•°åŒº */
        .card-type-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .card-type-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .card-type-name {
            font-size: 16px;
            color: #333;
        }

        .card-type-input {
            width: 80px;
            height: 38px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }

        /* ç©å®¶è®¾ç½®åŒº */
        .player-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .player-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-label {
            font-size: 16px;
            width: 60px;
        }

        .player-input {
            flex: 1;
            height: 44px;
            padding: 0 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        /* æŒ‰é’®é€šç”¨æ ·å¼ */
        .btn {
            width: 100%;
            height: 50px;
            line-height: 50px;
            text-align: center;
            background-color: #8B4513;
            color: #fff;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.2s;
        }

        .btn:hover {
            background-color: #A0522D;
        }

        /* ç»“ç®—é¡µæ ·å¼ */
        #calculate-page {
            display: none;
        }

        .back-btn {
            width: auto;
            padding: 0 15px;
            height: 40px;
            line-height: 40px;
            font-size: 16px;
            margin: 0 0 20px 0;
            display: inline-block;
        }

        /* æ’¤å›æŒ‰é’®æ ·å¼ */
        .undo-btn {
            width: auto;
            padding: 0 15px;
            height: 40px;
            line-height: 40px;
            font-size: 16px;
            margin: 0 10px 20px 0;
            display: inline-block;
            background-color: #6c757d;
        }

        .undo-btn:hover {
            background-color: #5a6268;
        }

        .undo-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .score-player-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .score-player-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #fff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .player-name {
            font-size: 18px;
            font-weight: 600;
        }

        .player-score {
            font-size: 20px;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
        }

        .score-positive {
            color: #2E8B57;
        }

        .score-negative {
            color: #DC143C;
        }

        .score-zero {
            color: #333;
        }

        .player-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            width: 70px;
            height: 36px;
            line-height: 36px;
            font-size: 14px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
        }

        .zim-btn {
            background-color: #4169E1;
            color: #fff;
        }

        .chihu-btn {
            background-color: #FF8C00;
            color: #fff;
        }

        /* å¼¹çª—æ ·å¼ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }

        .modal-content {
            background-color: #fff;
            border-radius: 12px;
            width: 90%;
            max-width: 350px;
            padding: 20px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 15px;
            color: #8B4513;
        }

        .modal-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .modal-option {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-option.active {
            background-color: #8B4513;
            color: #fff;
            border-color: #8B4513;
        }

        /* ä¸­ç æ•°é‡æ ·å¼ */
        .horse-count-title {
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            margin: 20px 0 15px;
            color: #8B4513;
        }

        .horse-count-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .horse-count-option {
            padding: 10px 0;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .horse-count-option.active {
            background-color: #8B4513;
            color: #fff;
            border-color: #8B4513;
        }

        .modal-footer {
            margin-top: 20px;
            text-align: center;
        }

        .modal-close {
            padding: 10px 20px;
            background-color: #eee;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
        }

        .modal-confirm {
            padding: 10px 20px;
            background-color: #8B4513;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <!-- 1. è®¾ç½®é¡µï¼ˆé»˜è®¤æ˜¾ç¤ºï¼‰ -->
    <div id="setting-page" class="container">
        <h1 class="page-title">ğŸ€„ éº»å°†ç§¯åˆ†è®¡ç®—å™¨</h1>

        <!-- æ‰“å¤šå¤§æ¨¡å— -->
        <div class="module">
            <h2 class="module-title">æ‰“å¤šå¤§</h2>
            <div class="size-options">
                <div class="size-option" data-value="1">123</div>
                <div class="size-option" data-value="2">246</div>
                <div class="size-option" data-value="5">555</div>
            </div>

            <!-- 6ç§ç‰Œå‹åˆ†æ•°åŒº -->
            <div class="card-type-list">
                <div class="card-type-item">
                    <span class="card-type-name">é¸¡èƒ¡</span>
                    <input type="number" class="card-type-input" id="jihu" readonly>
                </div>
                <div class="card-type-item">
                    <span class="card-type-name">æ‚è‰²</span>
                    <input type="number" class="card-type-input" id="zase" readonly>
                </div>
                <div class="card-type-item">
                    <span class="card-type-name">å¯¹å¯¹èƒ¡</span>
                    <input type="number" class="card-type-input" id="duiduihu" readonly>
                </div>
                <div class="card-type-item">
                    <span class="card-type-name">æ¸…ä¸€è‰²</span>
                    <input type="number" class="card-type-input" id="qingyise" readonly>
                </div>
                <div class="card-type-item">
                    <span class="card-type-name">å¤§å“¥</span>
                    <input type="number" class="card-type-input" id="dage" readonly>
                </div>
                <div class="card-type-item">
                    <span class="card-type-name">åä¸‰å¹º</span>
                    <input type="number" class="card-type-input" id="shisanyao" readonly>
                </div>
            </div>
        </div>

        <!-- ç©å®¶è®¾ç½®æ¨¡å— -->
        <div class="module">
            <h2 class="module-title">ç©å®¶è®¾ç½®</h2>
            <div class="player-list">
                <div class="player-item">
                    <label class="player-label">ç©å®¶1ï¼š</label>
                    <input type="text" class="player-input" id="player1" placeholder="è¯·è¾“å…¥åç§°" value="ç©å®¶1">
                </div>
                <div class="player-item">
                    <label class="player-label">ç©å®¶2ï¼š</label>
                    <input type="text" class="player-input" id="player2" placeholder="è¯·è¾“å…¥åç§°" value="ç©å®¶2">
                </div>
                <div class="player-item">
                    <label class="player-label">ç©å®¶3ï¼š</label>
                    <input type="text" class="player-input" id="player3" placeholder="è¯·è¾“å…¥åç§°" value="ç©å®¶3">
                </div>
                <div class="player-item">
                    <label class="player-label">ç©å®¶4ï¼š</label>
                    <input type="text" class="player-input" id="player4" placeholder="è¯·è¾“å…¥åç§°" value="ç©å®¶4">
                </div>
            </div>
        </div>

        <button class="btn" id="start-btn">å¼€å§‹éº»å°†</button>
    </div>

    <!-- 2. ç»“ç®—é¡µï¼ˆé»˜è®¤éšè—ï¼‰ -->
    <div id="calculate-page" class="container">
        <!-- æ’¤å›æŒ‰é’® + è¿”å›æŒ‰é’® -->
        <button class="btn back-btn" id="back-btn">è¿”å›è®¾ç½®</button>
        <button class="btn undo-btn" id="undo-btn" disabled>æ’¤å›ä¸Šä¸€æ­¥</button>
        <h1 class="page-title">ğŸ€„ ç§¯åˆ†ç»“ç®—</h1>

        <div class="score-player-list">
            <div class="score-player-item">
                <span class="player-name" id="score-player1">ç©å®¶1</span>
                <span class="player-score score-zero" id="score1">0</span>
                <div class="player-actions">
                    <button class="action-btn zim-btn" data-player="1">è‡ªæ‘¸</button>
                    <button class="action-btn chihu-btn" data-player="1">åƒèƒ¡</button>
                </div>
            </div>
            <div class="score-player-item">
                <span class="player-name" id="score-player2">ç©å®¶2</span>
                <span class="player-score score-zero" id="score2">0</span>
                <div class="player-actions">
                    <button class="action-btn zim-btn" data-player="2">è‡ªæ‘¸</button>
                    <button class="action-btn chihu-btn" data-player="2">åƒèƒ¡</button>
                </div>
            </div>
            <div class="score-player-item">
                <span class="player-name" id="score-player3">ç©å®¶3</span>
                <span class="player-score score-zero" id="score3">0</span>
                <div class="player-actions">
                    <button class="action-btn zim-btn" data-player="3">è‡ªæ‘¸</button>
                    <button class="action-btn chihu-btn" data-player="3">åƒèƒ¡</button>
                </div>
            </div>
            <div class="score-player-item">
                <span class="player-name" id="score-player4">ç©å®¶4</span>
                <span class="player-score score-zero" id="score4">0</span>
                <div class="player-actions">
                    <button class="action-btn zim-btn" data-player="4">è‡ªæ‘¸</button>
                    <button class="action-btn chihu-btn" data-player="4">åƒèƒ¡</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. è‡ªæ‘¸å¼¹çª— -->
    <div class="modal" id="zim-modal">
        <div class="modal-content">
            <h3 class="modal-title">é€‰æ‹©èƒ¡ç‰Œç±»å‹</h3>
            <div class="modal-options" id="zim-options">
                <div class="modal-option" data-type="jihu">é¸¡èƒ¡</div>
                <div class="modal-option" data-type="zase">æ‚è‰²</div>
                <div class="modal-option" data-type="duiduihu">å¯¹å¯¹èƒ¡</div>
                <div class="modal-option" data-type="qingyise">æ¸…ä¸€è‰²</div>
                <div class="modal-option" data-type="dage">å¤§å“¥</div>
                <div class="modal-option" data-type="shisanyao">åä¸‰å¹º</div>
            </div>
            
            <!-- æ–°å¢ä¸­ç æ•°é‡é€‰æ‹© -->
            <h3 class="horse-count-title">ä¸­ç æ•°é‡</h3>
            <div class="horse-count-options" id="zim-horse-options">
                <div class="horse-count-option" data-count="0">0</div>
                <div class="horse-count-option" data-count="1">1</div>
                <div class="horse-count-option" data-count="2">2</div>
                <div class="horse-count-option" data-count="3">3</div>
                <div class="horse-count-option" data-count="4">4</div>
                <div class="horse-count-option" data-count="5">5</div>
                <div class="horse-count-option" data-count="6">6</div>
                <div class="horse-count-option" data-count="7">7</div>
                <div class="horse-count-option" data-count="8">8</div>
            </div>

            <div class="modal-footer">
                <button class="modal-confirm" id="zim-confirm">ç¡®è®¤</button>
                <button class="modal-close" id="zim-close">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- 4. åƒèƒ¡å¼¹çª— -->
    <div class="modal" id="chihu-modal">
        <div class="modal-content">
            <h3 class="modal-title">é€‰æ‹©è¢«èƒ¡ç©å®¶</h3>
            <div class="modal-options" id="chihu-player-options">
                <!-- åŠ¨æ€ç”Ÿæˆå…¶ä½™ç©å®¶ -->
            </div>
            
            <h3 class="modal-title" style="margin-top: 20px;">é€‰æ‹©èƒ¡ç‰Œç±»å‹</h3>
            <div class="modal-options" id="chihu-type-options">
                <div class="modal-option" data-type="zase">æ‚è‰²</div>
                <div class="modal-option" data-type="duiduihu">å¯¹å¯¹èƒ¡</div>
                <div class="modal-option" data-type="qingyise">æ¸…ä¸€è‰²</div>
                <div class="modal-option" data-type="dage">å¤§å“¥</div>
                <div class="modal-option" data-type="shisanyao">åä¸‰å¹º</div>
            </div>
            
            <!-- æ–°å¢ä¸­ç æ•°é‡é€‰æ‹© -->
            <h3 class="horse-count-title">ä¸­ç æ•°é‡</h3>
            <div class="horse-count-options" id="chihu-horse-options">
                <div class="horse-count-option" data-count="0">0</div>
                <div class="horse-count-option" data-count="1">1</div>
                <div class="horse-count-option" data-count="2">2</div>
                <div class="horse-count-option" data-count="3">3</div>
                <div class="horse-count-option" data-count="4">4</div>
                <div class="horse-count-option" data-count="5">5</div>
                <div class="horse-count-option" data-count="6">6</div>
                <div class="horse-count-option" data-count="7">7</div>
                <div class="horse-count-option" data-count="8">8</div>
            </div>

            <div class="modal-footer">
                <button class="modal-confirm" id="chihu-confirm">ç¡®è®¤</button>
                <button class="modal-close" id="chihu-close">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // æ ¸å¿ƒæ•°æ®ï¼š6ç§ç‰Œå‹åŸºç¡€å€æ•°
        const cardTypeBase = {
            jihu: 3,
            zase: 6,
            duiduihu: 9,
            qingyise: 15,
            dage: 24,
            shisanyao: 39
        };
        let selectedSize = 1; // é»˜è®¤é€‰ä¸­123
        let currentPlayer = 0; // å½“å‰æ“ä½œçš„ç©å®¶
        let selectedChihuPlayer = 0; // åƒèƒ¡é€‰ä¸­çš„è¢«èƒ¡ç©å®¶
        let selectedCardType = ''; // é€‰ä¸­çš„ç‰Œå‹
        let selectedHorseCount = 0; // é€‰ä¸­çš„ä¸­ç æ•°é‡ï¼ˆé»˜è®¤0ï¼‰
        let operationHistory = []; // æ“ä½œå†å²æ•°ç»„

        // DOMå…ƒç´ è·å–
        const sizeOptions = document.querySelectorAll('.size-option');
        const startBtn = document.getElementById('start-btn');
        const backBtn = document.getElementById('back-btn');
        const undoBtn = document.getElementById('undo-btn');
        const settingPage = document.getElementById('setting-page');
        const calculatePage = document.getElementById('calculate-page');
        const zimModal = document.getElementById('zim-modal');
        const chihuModal = document.getElementById('chihu-modal');
        const zimOptions = document.getElementById('zim-options');
        const chihuPlayerOptions = document.getElementById('chihu-player-options');
        const chihuTypeOptions = document.getElementById('chihu-type-options');
        const zimClose = document.getElementById('zim-close');
        const chihuClose = document.getElementById('chihu-close');
        const zimConfirm = document.getElementById('zim-confirm');
        const chihuConfirm = document.getElementById('chihu-confirm');
        // ä¸­ç æ•°é‡DOM
        const zimHorseOptions = document.getElementById('zim-horse-options');
        const chihuHorseOptions = document.getElementById('chihu-horse-options');

        // 1. åˆå§‹åŒ–å¤§å°é€‰æ‹©é€»è¾‘
        sizeOptions.forEach(option => {
            option.addEventListener('click', () => {
                sizeOptions.forEach(opt => opt.classList.remove('active'));
                option.classList.add('active');
                selectedSize = parseInt(option.dataset.value);
                updateCardTypeScores(); // æ›´æ–°ç‰Œå‹åˆ†æ•°
            });
        });

        // 2. è®¡ç®—å¹¶æ›´æ–°ç‰Œå‹åˆ†æ•°
        function updateCardTypeScores() {
            for (const type in cardTypeBase) {
                document.getElementById(type).value = cardTypeBase[type] * selectedSize;
            }
        }

        // 3. å¼€å§‹éº»å°†ï¼šåˆ‡æ¢åˆ°ç»“ç®—é¡µ
        startBtn.addEventListener('click', () => {
            if (!document.querySelector('.size-option.active')) {
                alert('è¯·å…ˆé€‰æ‹©â€œæ‰“å¤šå¤§â€çš„æ¡£ä½ï¼');
                return;
            }
            // ä¿å­˜ç©å®¶åç§°åˆ°ç»“ç®—é¡µ
            document.getElementById('score-player1').textContent = document.getElementById('player1').value || 'ç©å®¶1';
            document.getElementById('score-player2').textContent = document.getElementById('player2').value || 'ç©å®¶2';
            document.getElementById('score-player3').textContent = document.getElementById('player3').value || 'ç©å®¶3';
            document.getElementById('score-player4').textContent = document.getElementById('player4').value || 'ç©å®¶4';
            // åˆ‡æ¢é¡µé¢æ˜¾ç¤º
            settingPage.style.display = 'none';
            calculatePage.style.display = 'block';
            // é‡ç½®æ“ä½œå†å²å’Œæ’¤å›æŒ‰é’®
            operationHistory = [];
            updateUndoBtnStatus();
        });

        // 4. è¿”å›è®¾ç½®é¡µ
        backBtn.addEventListener('click', () => {
            calculatePage.style.display = 'none';
            settingPage.style.display = 'block';
            // é‡ç½®æ“ä½œå†å²å’Œæ’¤å›æŒ‰é’®
            operationHistory = [];
            updateUndoBtnStatus();
        });

        // 5. è‡ªæ‘¸æŒ‰é’®ç‚¹å‡»é€»è¾‘
        document.querySelectorAll('.zim-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                currentPlayer = parseInt(btn.dataset.player);
                resetModalOptions(); // é‡ç½®å¼¹çª—é€‰ä¸­çŠ¶æ€
                zimModal.style.display = 'flex'; // æ˜¾ç¤ºè‡ªæ‘¸å¼¹çª—
            });
        });

        // 6. åƒèƒ¡æŒ‰é’®ç‚¹å‡»é€»è¾‘
        document.querySelectorAll('.chihu-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                currentPlayer = parseInt(btn.dataset.player);
                resetModalOptions();
                generateChihuPlayerOptions(); // ç”Ÿæˆè¢«èƒ¡ç©å®¶é€‰é¡¹
                chihuModal.style.display = 'flex'; // æ˜¾ç¤ºåƒèƒ¡å¼¹çª—
            });
        });

        // 7. ç”Ÿæˆåƒèƒ¡çš„è¢«èƒ¡ç©å®¶é€‰é¡¹ï¼ˆæ’é™¤å½“å‰ç©å®¶ï¼‰
        function generateChihuPlayerOptions() {
            chihuPlayerOptions.innerHTML = '';
            const playerNames = [
                document.getElementById('score-player1').textContent,
                document.getElementById('score-player2').textContent,
                document.getElementById('score-player3').textContent,
                document.getElementById('score-player4').textContent
            ];
            for (let i = 1; i <= 4; i++) {
                if (i !== currentPlayer) {
                    const option = document.createElement('div');
                    option.className = 'modal-option';
                    option.dataset.player = i;
                    option.textContent = playerNames[i-1];
                    option.addEventListener('click', () => {
                        chihuPlayerOptions.querySelectorAll('.modal-option').forEach(opt => opt.classList.remove('active'));
                        option.classList.add('active');
                        selectedChihuPlayer = parseInt(option.dataset.player);
                    });
                    chihuPlayerOptions.appendChild(option);
                }
            }
        }

        // 8. è‡ªæ‘¸ç‰Œå‹é€‰æ‹©
        zimOptions.querySelectorAll('.modal-option').forEach(option => {
            option.addEventListener('click', () => {
                zimOptions.querySelectorAll('.modal-option').forEach(opt => opt.classList.remove('active'));
                option.classList.add('active');
                selectedCardType = option.dataset.type;
            });
        });

        // 9. åƒèƒ¡ç‰Œå‹é€‰æ‹©
        chihuTypeOptions.querySelectorAll('.modal-option').forEach(option => {
            option.addEventListener('click', () => {
                chihuTypeOptions.querySelectorAll('.modal-option').forEach(opt => opt.classList.remove('active'));
                option.classList.add('active');
                selectedCardType = option.dataset.type;
            });
        });

        // 10. è‡ªæ‘¸ä¸­ç æ•°é‡é€‰æ‹©
        zimHorseOptions.querySelectorAll('.horse-count-option').forEach(option => {
            option.addEventListener('click', () => {
                zimHorseOptions.querySelectorAll('.horse-count-option').forEach(opt => opt.classList.remove('active'));
                option.classList.add('active');
                selectedHorseCount = parseInt(option.dataset.count);
            });
        });

        // 11. åƒèƒ¡ä¸­ç æ•°é‡é€‰æ‹©
        chihuHorseOptions.querySelectorAll('.horse-count-option').forEach(option => {
            option.addEventListener('click', () => {
                chihuHorseOptions.querySelectorAll('.horse-count-option').forEach(opt => opt.classList.remove('active'));
                option.classList.add('active');
                selectedHorseCount = parseInt(option.dataset.count);
            });
        });

        // 12. è‡ªæ‘¸ç¡®è®¤æŒ‰é’®é€»è¾‘
        zimConfirm.addEventListener('click', () => {
            if (!selectedCardType) {
                alert('è¯·å…ˆé€‰æ‹©èƒ¡ç‰Œç±»å‹ï¼');
                return;
            }
            calculateZimScore(); // è®¡ç®—è‡ªæ‘¸ç§¯åˆ†
            zimModal.style.display = 'none';
            updateUndoBtnStatus(); // æ›´æ–°æ’¤å›æŒ‰é’®çŠ¶æ€
        });

        // 13. åƒèƒ¡ç¡®è®¤æŒ‰é’®é€»è¾‘
        chihuConfirm.addEventListener('click', () => {
            if (!selectedChihuPlayer) {
                alert('è¯·å…ˆé€‰æ‹©è¢«èƒ¡ç©å®¶ï¼');
                return;
            }
            if (!selectedCardType) {
                alert('è¯·å…ˆé€‰æ‹©èƒ¡ç‰Œç±»å‹ï¼');
                return;
            }
            calculateChihuScore(); // è®¡ç®—åƒèƒ¡ç§¯åˆ†
            chihuModal.style.display = 'none';
            updateUndoBtnStatus(); // æ›´æ–°æ’¤å›æŒ‰é’®çŠ¶æ€
        });

        // 14. è‡ªæ‘¸ç§¯åˆ†è®¡ç®—è§„åˆ™
        // æœ€ç»ˆç§¯åˆ† = ç‰Œå‹åŸºç¡€åˆ† Ã— (1+ä¸­ç æ•°)
        // è‡ªæ‘¸ç©å®¶ï¼š+ 3 Ã— æœ€ç»ˆç§¯åˆ†
        // å…¶ä½™ç©å®¶ï¼š- 1 Ã— æœ€ç»ˆç§¯åˆ†
        function calculateZimScore() {
            // è®°å½•æ“ä½œå‰åˆ†æ•°
            const beforeScores = {
                1: parseInt(document.getElementById('score1').textContent),
                2: parseInt(document.getElementById('score2').textContent),
                3: parseInt(document.getElementById('score3').textContent),
                4: parseInt(document.getElementById('score4').textContent)
            };

            // è®¡ç®—æœ€ç»ˆç§¯åˆ†
            const baseScore = parseInt(document.getElementById(selectedCardType).value);
            const finalScore = baseScore * (1 + selectedHorseCount);
            
            // å½“å‰ç©å®¶åŠ åˆ†
            const currentScore = beforeScores[currentPlayer];
            updateScoreDisplay(`score${currentPlayer}`, currentScore + finalScore * 3);
            
            // å…¶ä½™ç©å®¶å‡åˆ†
            for (let i = 1; i <= 4; i++) {
                if (i !== currentPlayer) {
                    const playerScore = beforeScores[i];
                    updateScoreDisplay(`score${i}`, playerScore - finalScore);
                }
            }

            // è®°å½•æ“ä½œå†å²
            operationHistory.push({
                type: 'zim',
                player: currentPlayer,
                cardType: selectedCardType,
                horseCount: selectedHorseCount,
                beforeScores: beforeScores
            });
        }

        // 15. åƒèƒ¡ç§¯åˆ†è®¡ç®—è§„åˆ™
        // æœ€ç»ˆç§¯åˆ† = ç‰Œå‹åŸºç¡€åˆ† Ã— (1+ä¸­ç æ•°)
        // èƒ¡ç‰Œç©å®¶ï¼š+ 1 Ã— æœ€ç»ˆç§¯åˆ†
        // è¢«èƒ¡ç©å®¶ï¼š- 1 Ã— æœ€ç»ˆç§¯åˆ†
        function calculateChihuScore() {
            // è®°å½•æ“ä½œå‰åˆ†æ•°
            const beforeScores = {
                1: parseInt(document.getElementById('score1').textContent),
                2: parseInt(document.getElementById('score2').textContent),
                3: parseInt(document.getElementById('score3').textContent),
                4: parseInt(document.getElementById('score4').textContent)
            };

            // è®¡ç®—æœ€ç»ˆç§¯åˆ†
            const baseScore = parseInt(document.getElementById(selectedCardType).value);
            const finalScore = baseScore * (1 + selectedHorseCount);
            
            // å½“å‰ç©å®¶åŠ åˆ†
            const currentScore = beforeScores[currentPlayer];
            updateScoreDisplay(`score${currentPlayer}`, currentScore + finalScore);
            
            // è¢«èƒ¡ç©å®¶å‡åˆ†
            const beihuScore = beforeScores[selectedChihuPlayer];
            updateScoreDisplay(`score${selectedChihuPlayer}`, beihuScore - finalScore);

            // è®°å½•æ“ä½œå†å²
            operationHistory.push({
                type: 'chihu',
                player: currentPlayer,
                beihuPlayer: selectedChihuPlayer,
                cardType: selectedCardType,
                horseCount: selectedHorseCount,
                beforeScores: beforeScores
            });
        }

        // 16. æ›´æ–°ç§¯åˆ†æ˜¾ç¤ºï¼ˆå«é¢œè‰²åŒºåˆ†ï¼‰
        function updateScoreDisplay(scoreId, score) {
            const el = document.getElementById(scoreId);
            el.textContent = score;
            el.classList.remove('score-positive', 'score-negative', 'score-zero');
            if (score > 0) el.classList.add('score-positive');
            else if (score < 0) el.classList.add('score-negative');
            else el.classList.add('score-zero');
        }

        // 17. é‡ç½®å¼¹çª—é€‰ä¸­çŠ¶æ€
        function resetModalOptions() {
            selectedChihuPlayer = 0;
            selectedCardType = '';
            selectedHorseCount = 0;
            // é‡ç½®ç‰Œå‹é€‰ä¸­çŠ¶æ€
            zimOptions.querySelectorAll('.modal-option').forEach(opt => opt.classList.remove('active'));
            chihuPlayerOptions.querySelectorAll('.modal-option').forEach(opt => opt.classList.remove('active'));
            chihuTypeOptions.querySelectorAll('.modal-option').forEach(opt => opt.classList.remove('active'));
            // é‡ç½®ä¸­ç æ•°é‡é€‰ä¸­çŠ¶æ€
            zimHorseOptions.querySelectorAll('.horse-count-option').forEach(opt => opt.classList.remove('active'));
            chihuHorseOptions.querySelectorAll('.horse-count-option').forEach(opt => opt.classList.remove('active'));
        }

        // 18. å…³é—­å¼¹çª—
        zimClose.addEventListener('click', () => {
            zimModal.style.display = 'none';
            resetModalOptions();
        });
        chihuClose.addEventListener('click', () => {
            chihuModal.style.display = 'none';
            resetModalOptions();
        });

        // 19. æ›´æ–°æ’¤å›æŒ‰é’®çŠ¶æ€
        function updateUndoBtnStatus() {
            undoBtn.disabled = operationHistory.length === 0;
        }

        // 20. æ’¤å›æ“ä½œé€»è¾‘
        function undoLastOperation() {
            if (operationHistory.length === 0) return;
            
            // å–å‡ºæœ€åä¸€æ¡æ“ä½œè®°å½•
            const lastOp = operationHistory.pop();
            // æ¢å¤åˆ°æ“ä½œå‰çš„åˆ†æ•°çŠ¶æ€
            for (let i = 1; i <= 4; i++) {
                updateScoreDisplay(`score${i}`, lastOp.beforeScores[i]);
            }
            
            // æ›´æ–°æ’¤å›æŒ‰é’®çŠ¶æ€
            updateUndoBtnStatus();
        }

        // ç»‘å®šæ’¤å›æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        undoBtn.addEventListener('click', undoLastOperation);

        // åˆå§‹åŒ–ï¼šé»˜è®¤é€‰ä¸­123å¹¶è®¡ç®—åˆ†æ•°
        document.querySelector('.size-option[data-value="1"]').click();
    </script>
</body>
</html>
